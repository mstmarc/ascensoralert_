<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartera y An√°lisis</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=6">
    <style>
        /* HEADER CENTRADO */
        header .header-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        header .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Estilos espec√≠ficos para cartera */
        .cartera-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            font-family: 'Montserrat', sans-serif;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-header h1 {
            font-size: 28px;
            color: #003366;
            margin: 0;
        }

        .btn-importar {
            background: #366092;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-importar:hover {
            background: #003366;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(54, 96, 146, 0.3);
        }

        /* Cards de m√©tricas */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #f0f0f0;
            transition: all 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 75, 141, 0.2);
            border-color: #003366;
        }

        .metric-card .icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .metric-card .number {
            font-size: 32px;
            font-weight: 700;
            color: #003366;
            margin: 10px 0;
        }

        .metric-card .label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .metric-card.warning {
            border-color: #ff9800;
        }

        .metric-card.warning .number {
            color: #ff9800;
        }

        .metric-card.danger {
            border-color: #f44336;
        }

        .metric-card.danger .number {
            color: #f44336;
        }

        .metric-card.success {
            border-color: #4CAF50;
        }

        .metric-card.success .number {
            color: #4CAF50;
        }

        /* Secciones de contenido */
        .content-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .content-section h2 {
            font-size: 20px;
            color: #003366;
            margin-bottom: 20px;
            border-bottom: 2px solid #e6f2ff;
            padding-bottom: 10px;
        }

        /* Tabla de m√°quinas problem√°ticas */
        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #003366;
            border-bottom: 2px solid #dee2e6;
            font-size: 13px;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-critico {
            background: #ffebee;
            color: #c62828;
        }

        .badge-alto {
            background: #fff3e0;
            color: #e65100;
        }

        .badge-medio {
            background: #fff9c4;
            color: #f57f17;
        }

        .badge-bajo {
            background: #e8f5e9;
            color: #2e7d32;
        }

        /* Gr√°fico de barras simple */
        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .chart-label {
            width: 150px;
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }

        .chart-bar-container {
            flex: 1;
            height: 30px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .chart-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #366092, #5a8fc4);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .chart-value {
            width: 60px;
            text-align: right;
            font-size: 13px;
            font-weight: 600;
            color: #003366;
            margin-left: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .cartera-container {
                padding: 15px 10px;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .chart-label {
                width: 100px;
                font-size: 11px;
            }

            .chart-value {
                width: 50px;
                font-size: 11px;
            }
        }

        main {
            max-width: none !important;
            padding: 30px !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo-container">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo">
            </div>
        </div>
    </header>

    <!-- Contenido principal -->
    <main>
        <div class="cartera-container">
            <!-- Encabezado de p√°gina -->
            <div class="page-header">
                <h1>üìä Cartera y An√°lisis</h1>
                <div style="display: flex; gap: 10px;">
                    <a href="/cartera/oportunidades" class="btn-importar" style="background: #28a745;">
                        üí∞ Oportunidades
                    </a>
                    <a href="/cartera/importar" class="btn-importar">
                        ‚¨ÜÔ∏è Importar Datos
                    </a>
                </div>
            </div>

            <!-- Mensajes flash -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}" style="padding: 15px; margin-bottom: 20px; border-radius: 8px; background: {% if category == 'success' %}#d4edda{% elif category == 'error' %}#f8d7da{% elif category == 'warning' %}#fff3cd{% else %}#d1ecf1{% endif %}; color: {% if category == 'success' %}#155724{% elif category == 'error' %}#721c24{% elif category == 'warning' %}#856404{% else %}#0c5460{% endif %};">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- KPIs Principales -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="icon">üè¢</div>
                    <div class="number">{{ stats.total_instalaciones or 0 }}</div>
                    <div class="label">Instalaciones</div>
                </div>

                <div class="metric-card">
                    <div class="icon">üõó</div>
                    <div class="number">{{ stats.total_maquinas or 0 }}</div>
                    <div class="label">M√°quinas</div>
                </div>

                <div class="metric-card success">
                    <div class="icon">üìã</div>
                    <div class="number">{{ stats.total_partes or 0 }}</div>
                    <div class="label">Partes Totales</div>
                </div>

                <div class="metric-card danger">
                    <div class="icon">‚ö†Ô∏è</div>
                    <div class="number">{{ stats.averias_anio or 0 }}</div>
                    <div class="label">Aver√≠as (12 meses)</div>
                </div>

                <div class="metric-card success">
                    <div class="icon">üîß</div>
                    <div class="number">{{ stats.mantenimientos_anio or 0 }}</div>
                    <div class="label">Mantenimientos (12 meses)</div>
                </div>

                <div class="metric-card warning">
                    <div class="icon">üí°</div>
                    <div class="number">{{ stats.recomendaciones_pendientes or 0 }}</div>
                    <div class="label">Recomendaciones Pendientes</div>
                </div>
            </div>

            {% if stats.total_partes != '0' %}
                <!-- Top M√°quinas Problem√°ticas -->
                <div class="content-section">
                    <h2>üö® Top 10 M√°quinas Problem√°ticas</h2>

                    {% if maquinas_problematicas %}
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>M√°quina</th>
                                        <th>Instalaci√≥n</th>
                                        <th>Municipio</th>
                                        <th style="text-align: center;">Aver√≠as (A√±o)</th>
                                        <th style="text-align: center;">Aver√≠as (Trim)</th>
                                        <th style="text-align: center;">√çndice</th>
                                        <th style="text-align: center;">Riesgo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for maquina in maquinas_problematicas %}
                                        <tr>
                                            <td>
                                                <a href="/cartera/maquina/{{ maquina.maquina_id }}" style="color: #366092; text-decoration: none; font-weight: 600;">
                                                    {{ maquina.identificador }}
                                                </a>
                                            </td>
                                            <td>
                                                <a href="/cartera/instalacion/{{ maquina.instalacion_id }}" style="color: #366092; text-decoration: none;">
                                                    {{ maquina.instalacion_nombre }}
                                                </a>
                                            </td>
                                            <td>{{ maquina.municipio or '-' }}</td>
                                            <td style="text-align: center;">{{ maquina.averias_ultimo_a√±o or 0 }}</td>
                                            <td style="text-align: center;">{{ maquina.averias_ultimo_trimestre or 0 }}</td>
                                            <td style="text-align: center;"><strong>{{ maquina.indice_problema or 0 }}</strong></td>
                                            <td style="text-align: center;">
                                                <span class="badge badge-{{ maquina.nivel_riesgo.lower() }}">
                                                    {{ maquina.nivel_riesgo }}
                                                </span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p style="color: #666; text-align: center; padding: 20px;">
                            No se encontraron m√°quinas con √≠ndice de problema elevado
                        </p>
                    {% endif %}
                </div>

                <!-- Recomendaciones Pendientes -->
                <div class="content-section">
                    <h2>üí° Recomendaciones Pendientes de Revisar</h2>

                    {% if recomendaciones %}
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>N¬∞ Parte</th>
                                        <th>M√°quina</th>
                                        <th>Instalaci√≥n</th>
                                        <th>Recomendaci√≥n</th>
                                        <th style="text-align: center; width: 150px;">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for rec in recomendaciones %}
                                        <tr>
                                            <td>{{ rec.fecha_parte[:10] }}</td>
                                            <td>{{ rec.numero_parte }}</td>
                                            <td>
                                                <a href="/cartera/maquina/{{ rec.maquina_id }}" style="color: #366092; text-decoration: none; font-weight: 600;">
                                                    {{ rec.maquina_identificador }}
                                                </a>
                                            </td>
                                            <td>
                                                <a href="/cartera/instalacion/{{ rec.instalacion_id }}" style="color: #366092; text-decoration: none;">
                                                    {{ rec.instalacion_nombre }}
                                                </a>
                                            </td>
                                            <td style="max-width: 500px; white-space: normal; word-wrap: break-word; line-height: 1.4;">{{ rec.recomendaciones_extraidas }}</td>
                                            <td style="text-align: center;">
                                                <div style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                                                    <a href="/cartera/oportunidades/crear/{{ rec.id }}"
                                                       style="display: inline-block; padding: 6px 12px; background: #28a745; color: white; text-decoration: none; border-radius: 6px; font-size: 12px; font-weight: 600; white-space: nowrap;">
                                                        üí∞ Crear Oportunidad
                                                    </a>
                                                    <form method="POST" action="/cartera/recomendaciones/{{ rec.id }}/descartar" style="margin: 0;" onsubmit="return confirm('¬øDescartar esta recomendaci√≥n? No se crear√° ninguna oportunidad.');">
                                                        <button type="submit" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                                            ‚ùå Descartar
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginaci√≥n -->
                        {% if pagination.total_pages > 1 %}
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="color: #666; font-size: 13px;">
                                Mostrando {{ ((pagination.page - 1) * pagination.per_page) + 1 }} - {{ [pagination.page * pagination.per_page, pagination.total]|min }} de {{ pagination.total }} recomendaciones
                            </div>
                            <div style="display: flex; gap: 8px;">
                                {% if pagination.has_prev %}
                                    <a href="/cartera?page=1" style="padding: 8px 12px; background: white; border: 2px solid #dee2e6; border-radius: 6px; text-decoration: none; color: #003366; font-weight: 600; font-size: 13px;">
                                        ¬´ Primera
                                    </a>
                                    <a href="/cartera?page={{ pagination.prev_page }}" style="padding: 8px 12px; background: white; border: 2px solid #dee2e6; border-radius: 6px; text-decoration: none; color: #003366; font-weight: 600; font-size: 13px;">
                                        ‚Äπ Anterior
                                    </a>
                                {% else %}
                                    <span style="padding: 8px 12px; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 6px; color: #999; font-weight: 600; font-size: 13px;">
                                        ¬´ Primera
                                    </span>
                                    <span style="padding: 8px 12px; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 6px; color: #999; font-weight: 600; font-size: 13px;">
                                        ‚Äπ Anterior
                                    </span>
                                {% endif %}

                                <span style="padding: 8px 16px; background: #003366; color: white; border-radius: 6px; font-weight: 600; font-size: 13px;">
                                    P√°gina {{ pagination.page }} de {{ pagination.total_pages }}
                                </span>

                                {% if pagination.has_next %}
                                    <a href="/cartera?page={{ pagination.next_page }}" style="padding: 8px 12px; background: white; border: 2px solid #dee2e6; border-radius: 6px; text-decoration: none; color: #003366; font-weight: 600; font-size: 13px;">
                                        Siguiente ‚Ä∫
                                    </a>
                                    <a href="/cartera?page={{ pagination.total_pages }}" style="padding: 8px 12px; background: white; border: 2px solid #dee2e6; border-radius: 6px; text-decoration: none; color: #003366; font-weight: 600; font-size: 13px;">
                                        √öltima ¬ª
                                    </a>
                                {% else %}
                                    <span style="padding: 8px 12px; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 6px; color: #999; font-weight: 600; font-size: 13px;">
                                        Siguiente ‚Ä∫
                                    </span>
                                    <span style="padding: 8px 12px; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 6px; color: #999; font-weight: 600; font-size: 13px;">
                                        √öltima ¬ª
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <p style="color: #666; text-align: center; padding: 20px;">
                            ‚úÖ No hay recomendaciones pendientes de revisar
                        </p>
                    {% endif %}
                </div>

                <!-- Distribuci√≥n de Tipos de Parte -->
                <div class="content-section">
                    <h2>üìä Distribuci√≥n de Tipos de Parte (√öltimo A√±o)</h2>

                    {% if tipos_distribucion %}
                        {% set max_value = tipos_distribucion.values()|max %}
                        {% for tipo, cantidad in tipos_distribucion.items()|sort(attribute='1', reverse=true) %}
                            <div class="chart-bar">
                                <div class="chart-label">{{ tipo }}</div>
                                <div class="chart-bar-container">
                                    <div class="chart-bar-fill" style="width: {{ (cantidad / max_value * 100)|round }}%;"></div>
                                </div>
                                <div class="chart-value">{{ cantidad }}</div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p style="color: #666; text-align: center; padding: 20px;">
                            No hay datos de tipos de parte
                        </p>
                    {% endif %}
                </div>

            {% else %}
                <!-- Estado vac√≠o -->
                <div class="content-section">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">üì¶</div>
                        <p style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">No hay datos importados a√∫n</p>
                        <p style="color: #666; margin-bottom: 25px;">Para comenzar, importa los datos de cartera y partes de trabajo desde Excel.</p>
                        <a href="/cartera/importar" class="btn-importar" style="display: inline-block;">
                            ‚¨ÜÔ∏è Ir a Importar
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </main>

    <!-- Scripts -->
    <script>
        // Inyectar permisos del usuario para el sidebar
        window.userPermissions = {{ permisos_usuario_json | safe }};
        window.perfilUsuario = '{{ perfil_usuario }}';
    </script>
    <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
</body>
</html>

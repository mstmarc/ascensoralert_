<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ instalacion.nombre }} - Instalaci√≥n</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=6">
    <style>
        header .header-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .detalle-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            font-family: 'Montserrat', sans-serif;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
        }

        .header-left h1 {
            font-size: 26px;
            color: #003366;
            margin: 0 0 8px 0;
        }

        .header-subtitle {
            color: #666;
            font-size: 14px;
            margin: 0;
        }

        .btn-volver {
            background: #6c757d;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-volver:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: 700;
            color: #003366;
            margin-bottom: 8px;
        }

        .stat-card .label {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-card.maquinas {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card.maquinas .number,
        .stat-card.maquinas .label {
            color: white;
        }

        .stat-card.averias {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-card.averias .number,
        .stat-card.averias .label {
            color: white;
        }

        .stat-card.mantenimientos {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-card.mantenimientos .number,
        .stat-card.mantenimientos .label {
            color: white;
        }

        .stat-card.recomendaciones {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .stat-card.oportunidades {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        /* Section Cards */
        .section-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .section-card h2 {
            font-size: 18px;
            color: #003366;
            margin: 0 0 20px 0;
            padding-bottom: 12px;
            border-bottom: 2px solid #e6f2ff;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .info-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #366092;
        }

        .info-label {
            font-weight: 600;
            color: #003366;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-value {
            color: #333;
            font-size: 14px;
        }

        /* Tabla de M√°quinas */
        .maquinas-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .maquinas-table thead {
            background: #f8f9fa;
        }

        .maquinas-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #003366;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #dee2e6;
        }

        .maquinas-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .maquinas-table tbody tr {
            transition: all 0.2s;
        }

        .maquinas-table tbody tr:hover {
            background: #f8f9fa;
        }

        .maquinas-table a {
            color: #366092;
            text-decoration: none;
            font-weight: 600;
        }

        .maquinas-table a:hover {
            text-decoration: underline;
        }

        /* Gr√°fico de barras */
        .chart-container {
            margin-top: 20px;
        }

        .chart-bar {
            margin-bottom: 15px;
        }

        .chart-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
            color: #333;
        }

        .chart-label span:first-child {
            font-weight: 600;
            color: #003366;
        }

        .chart-bar-bg {
            background: #e9ecef;
            border-radius: 10px;
            height: 28px;
            overflow: hidden;
            position: relative;
        }

        .chart-bar-fill {
            background: linear-gradient(90deg, #366092 0%, #5a8bc4 100%);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            transition: width 0.5s ease;
        }

        /* Tablas de datos */
        .partes-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .partes-table thead {
            background: #f8f9fa;
        }

        .partes-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #003366;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #dee2e6;
        }

        .partes-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .partes-table tbody tr {
            transition: all 0.2s;
        }

        .partes-table tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-aver√≠a { background: #ffebee; color: #c62828; }
        .badge-conservaci√≥n { background: #e3f2fd; color: #1976d2; }
        .badge-modernizaci√≥n { background: #f3e5f5; color: #7b1fa2; }
        .badge-otro { background: #f5f5f5; color: #616161; }

        .badge-tipo {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-prioridad-ALTA { background: #ffebee; color: #c62828; }
        .badge-prioridad-MEDIA { background: #fff9c4; color: #f57f17; }
        .badge-prioridad-BAJA { background: #e8f5e9; color: #2e7d32; }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .detalle-container {
                padding: 15px 10px;
            }

            .page-header {
                flex-direction: column;
                gap: 15px;
            }

            .header-left h1 {
                font-size: 22px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .maquinas-table,
            .partes-table {
                font-size: 12px;
            }

            .maquinas-table th,
            .maquinas-table td,
            .partes-table th,
            .partes-table td {
                padding: 8px;
            }
        }

        main {
            max-width: none !important;
            padding: 30px !important;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo-container">
                <img src="{{ url_for('static', filename='logo-fedes-ascensores.png') }}" alt="Logo" class="logo">
            </div>
        </div>
    </header>

    <main>
        <div class="detalle-container">
            <!-- Encabezado -->
            <div class="page-header">
                <div class="header-left">
                    <h1>{{ instalacion.nombre }}</h1>
                    {% if instalacion.municipio %}
                    <p class="header-subtitle">
                        üìç {{ instalacion.municipio }}
                    </p>
                    {% endif %}
                </div>
                <a href="/cartera" class="btn-volver">
                    ‚Üê Volver al Dashboard
                </a>
            </div>

            <!-- Grid de Estad√≠sticas -->
            <div class="stats-grid">
                <div class="stat-card maquinas">
                    <div class="number">{{ stats.total_maquinas }}</div>
                    <div class="label">M√°quinas</div>
                </div>

                <div class="stat-card">
                    <div class="number">{{ stats.total_partes }}</div>
                    <div class="label">Total Partes</div>
                </div>

                <div class="stat-card averias">
                    <div class="number">{{ stats.total_averias }}</div>
                    <div class="label">Aver√≠as</div>
                </div>

                <div class="stat-card mantenimientos">
                    <div class="number">{{ stats.total_mantenimientos }}</div>
                    <div class="label">Mantenimientos</div>
                </div>

                <div class="stat-card recomendaciones">
                    <div class="number">{{ stats.total_recomendaciones }}</div>
                    <div class="label">Recomendaciones</div>
                </div>

                <div class="stat-card oportunidades">
                    <div class="number">{{ stats.total_oportunidades }}</div>
                    <div class="label">Oportunidades</div>
                </div>
            </div>

            <!-- Informaci√≥n de la Instalaci√≥n -->
            <div class="section-card">
                <h2>üìã Informaci√≥n de la Instalaci√≥n</h2>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Nombre</div>
                        <div class="info-value">{{ instalacion.nombre }}</div>
                    </div>

                    {% if instalacion.municipio %}
                    <div class="info-item">
                        <div class="info-label">Municipio</div>
                        <div class="info-value">{{ instalacion.municipio }}</div>
                    </div>
                    {% endif %}

                    <div class="info-item">
                        <div class="info-label">Total M√°quinas</div>
                        <div class="info-value">{{ stats.total_maquinas }}</div>
                    </div>
                </div>
            </div>

            <!-- M√°quinas de la Instalaci√≥n -->
            <div class="section-card">
                <h2>üõó M√°quinas de esta Instalaci√≥n</h2>

                {% if maquinas %}
                    <table class="maquinas-table">
                        <thead>
                            <tr>
                                <th>Identificador</th>
                                <th>C√≥digo</th>
                                <th>Tipo</th>
                                <th>T√©cnico</th>
                                <th>Estado</th>
                                <th style="text-align: center;">Partes</th>
                                <th style="text-align: center;">Aver√≠as</th>
                                <th style="text-align: center;">Recomendaciones</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for maquina in maquinas %}
                            <tr>
                                <td><strong>{{ maquina.identificador }}</strong></td>
                                <td>{{ maquina.codigo_maquina or '-' }}</td>
                                <td>{{ maquina.tipo_maquina or '-' }}</td>
                                <td>{{ maquina.tecnico_asignado or '-' }}</td>
                                <td>{{ maquina.estado or '-' }}</td>
                                <td style="text-align: center;">{{ maquina.total_partes }}</td>
                                <td style="text-align: center;">{{ maquina.total_averias }}</td>
                                <td style="text-align: center;">{{ maquina.total_recomendaciones }}</td>
                                <td>
                                    <a href="/cartera/maquina/{{ maquina.id }}">
                                        Ver Detalle ‚Üí
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <div class="icon">üõó</div>
                        <p>No hay m√°quinas registradas en esta instalaci√≥n</p>
                    </div>
                {% endif %}
            </div>

            <!-- Distribuci√≥n de Tipos de Partes -->
            {% if tipos_distribucion %}
            <div class="section-card">
                <h2>üìä Distribuci√≥n de Tipos de Partes</h2>

                <div class="chart-container">
                    {% set max_value = tipos_distribucion.values()|max %}
                    {% for tipo, cantidad in tipos_distribucion.items()|sort(attribute='1', reverse=true) %}
                        <div class="chart-bar">
                            <div class="chart-label">
                                <span>{{ tipo }}</span>
                                <span>{{ cantidad }} partes</span>
                            </div>
                            <div class="chart-bar-bg">
                                <div class="chart-bar-fill" style="width: {{ (cantidad / max_value * 100)|round }}%;">
                                    {{ (cantidad / stats.total_partes * 100)|round(1) }}%
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Oportunidades de Facturaci√≥n -->
            {% if oportunidades %}
            <div class="section-card">
                <h2>üí∞ Oportunidades de Facturaci√≥n</h2>

                <table class="partes-table">
                    <thead>
                        <tr>
                            <th>M√°quina</th>
                            <th>T√≠tulo</th>
                            <th>Tipo</th>
                            <th>Prioridad</th>
                            <th>Estado</th>
                            <th>Creada</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for op in oportunidades %}
                        <tr>
                            <td>
                                {% if op.maquinas_cartera %}
                                    <strong>{{ op.maquinas_cartera.identificador }}</strong>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ op.titulo }}</td>
                            <td>
                                <span class="badge badge-tipo">{{ op.tipo }}</span>
                            </td>
                            <td>
                                <span class="badge badge-prioridad-{{ op.prioridad_comercial }}">
                                    {{ op.prioridad_comercial }}
                                </span>
                            </td>
                            <td>{{ op.estado.replace('_', ' ') }}</td>
                            <td>{{ op.created_at[:10] }}</td>
                            <td>
                                <a href="/cartera/oportunidades/{{ op.id }}">
                                    Ver ‚Üí
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

            <!-- Recomendaciones Detectadas -->
            {% if recomendaciones %}
            <div class="section-card">
                <h2>‚ö†Ô∏è Recomendaciones Detectadas</h2>

                <table class="partes-table">
                    <thead>
                        <tr>
                            <th>M√°quina</th>
                            <th>Fecha</th>
                            <th>N¬∞ Parte</th>
                            <th>Tipo</th>
                            <th>Recomendaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rec in recomendaciones %}
                        <tr>
                            <td>
                                {% if rec.maquinas_cartera %}
                                    <strong>{{ rec.maquinas_cartera.identificador }}</strong>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ rec.fecha_parte[:10] }}</td>
                            <td><strong>{{ rec.numero_parte }}</strong></td>
                            <td>
                                <span class="badge badge-{{ rec.tipo_parte_normalizado|lower }}">
                                    {{ rec.tipo_parte_normalizado }}
                                </span>
                            </td>
                            <td style="max-width: 400px; white-space: normal;">
                                {{ rec.recomendaciones_extraidas }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

            <!-- Historial de Partes (√∫ltimos 100) -->
            {% if partes %}
            <div class="section-card">
                <h2>üìÑ Historial de Partes (√∫ltimos 100)</h2>

                <table class="partes-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>M√°quina</th>
                            <th>N¬∞ Parte</th>
                            <th>Tipo</th>
                            <th>Resoluci√≥n</th>
                            <th style="text-align: center;">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for parte in partes %}
                        <tr>
                            <td>{{ parte.fecha_parte[:10] }}</td>
                            <td>
                                {% if parte.maquinas_cartera %}
                                    <strong>{{ parte.maquinas_cartera.identificador }}</strong>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td><strong>{{ parte.numero_parte }}</strong></td>
                            <td>
                                {% set tipo = parte.tipo_parte_normalizado or 'OTRO' %}
                                <span class="badge badge-{{ tipo|lower }}">
                                    {{ tipo }}
                                </span>
                            </td>
                            <td style="max-width: 400px; white-space: normal; word-wrap: break-word;">
                                {{ parte.resolucion[:100] + '...' if parte.resolucion and parte.resolucion|length > 100 else (parte.resolucion or '-') }}
                            </td>
                            <td style="text-align: center;">
                                <a href="/cartera/oportunidades/crear/{{ parte.id }}"
                                   style="display: inline-block; padding: 4px 10px; background: #28a745; color: white; text-decoration: none; border-radius: 4px; font-size: 11px; font-weight: 600;"
                                   title="Crear oportunidad desde este parte">
                                    üí∞ Crear
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </main>

    <script>
        window.userPermissions = {{ permisos_usuario_json | safe }};
        window.perfilUsuario = '{{ perfil_usuario }}';
    </script>
    <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle Lead</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=9">
    <link rel="stylesheet" href="{{ url_for('static', filename='components.css') }}?v=1">
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo-container">
                <a href="/home">
                    <img src="{{ url_for('static', filename='logo-fedes-ascensores.png') }}" alt="Logo Fedes Ascensores" class="logo">
                </a>
            </div>
        </div>
    </header>

    <main class="main--full-width">
        <div class="page-container">
            <div class="page-header">
                <div class="page-header__left">
                    <h1>Detalle de la Comunidad</h1>
                </div>
            </div>

            <!-- INFORMACIÓN GENERAL -->
            <div class="seccion">
                <h2>Información General</h2>

                <div class="info-list">
                    <div class="info-item">
                        <label>Primera Visita</label>
                        <span>{{ lead.fecha_visita|format_fecha }}</span>
                    </div>

                    <div class="info-item">
                        <label>Tipo</label>
                        <span>{{ lead.tipo_cliente or '-' }}</span>
                    </div>

                    <div class="info-item">
                        <label>Dirección</label>
                        {% if lead.direccion and lead.localidad %}
                            <a href="https://www.google.com/maps/search/?api=1&query={{ lead.direccion|urlencode }}+{{ lead.localidad|urlencode }}" target="_blank" rel="noopener noreferrer">
                                {{ lead.direccion }}
                            </a>
                        {% else %}
                            <span>{{ lead.direccion or '-' }}</span>
                        {% endif %}
                    </div>

                    <div class="info-item">
                        <label>Nombre</label>
                        <span>{{ lead.nombre_cliente or '-' }}</span>
                    </div>

                    <div class="info-item">
                        <label>Código Postal</label>
                        <span>{{ lead.codigo_postal or '-' }}</span>
                    </div>

                    <div class="info-item">
                        <label>Población</label>
                        <span>{{ lead.localidad or '-' }}</span>
                    </div>

                    <div class="info-item">
                        <label>Administrador de Fincas</label>
                        {% if administrador %}
                            <a href="/ver_administrador/{{ administrador.id }}">{{ administrador.nombre_empresa }}</a>
                        {% else %}
                            <span>-</span>
                        {% endif %}
                    </div>

                    <div class="info-item">
                        <label>Nº Ascensores</label>
                        <span>{{ lead.numero_ascensores or '-' }}</span>
                    </div>

                    <div class="info-item">
                        <label>Empresa Mantenedora</label>
                        {% if lead.empresa_mantenedora %}
                            <a href="{{ url_for('leads.dashboard') }}?empresa={{ lead.empresa_mantenedora|urlencode }}">{{ lead.empresa_mantenedora }}</a>
                        {% else %}
                            <span>-</span>
                        {% endif %}
                    </div>

                    <div class="info-item">
                        <label>Fecha Fin de Contrato</label>
                        <span>{{ lead.fecha_fin_contrato|format_fecha }}</span>
                    </div>

                    <div class="info-item">
                        <label>Paradas</label>
                        <span>{{ lead.paradas or '-' }}</span>
                    </div>

                    <div class="info-item">
                        <label>Viviendas por Planta</label>
                        <span>{{ lead.viviendas_por_planta or '-' }}</span>
                    </div>

                    <div class="info-item">
                        <label>Persona de Contacto</label>
                        <span>{{ lead.persona_contacto or '-' }}</span>
                    </div>

                    <div class="info-item">
                        <label>Teléfono</label>
                        <span>{{ lead.telefono or '-' }}</span>
                    </div>

                    <div class="info-item">
                        <label>Email</label>
                        <span>{{ lead.email or '-' }}</span>
                    </div>
                </div>

                <div class="mt-lg">
                    <label class="font-bold text-primary">Observaciones:</label>
                    <div class="mt-sm text-secondary">{{ lead.observaciones or 'Sin observaciones' }}</div>
                </div>
            </div>

            <!-- EQUIPOS/ASCENSORES -->
            <div class="seccion">
                <h2>Equipos / Ascensores</h2>

                {% if equipos %}
                    {% for equipo in equipos %}
                    <div class="list-item">
                        <div class="list-item__info">
                            <div class="list-item__title">{{ equipo.tipo_equipo }}</div>
                            <div class="list-item__details">RAE: {{ equipo.rae or '-' }} • Próxima IPO: {{ equipo.ipo_proxima|format_fecha }}</div>
                        </div>
                        <div class="list-item__actions">
                            <a href="{{ url_for('equipos.ver', equipo_id=equipo.id) }}" class="btn btn--primary btn--sm btn--rounded">Ver detalle</a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="estado-vacio">Esta instalación aún no tiene equipos registrados</div>
                {% endif %}

                <div class="add-item-button">
                    <a href="{{ url_for('equipos.nuevo', lead_id=lead.id) }}" class="btn btn--primary btn--rounded">+ Añadir Equipo</a>
                </div>
            </div>

            <!-- HISTORIAL DE VISITAS -->
            <div class="seccion">
                <h2>Historial de Visitas</h2>

                {% if todas_visitas %}
                    {% for visita in todas_visitas %}
                    <div class="visita-item">
                        <div class="visita-fecha">
                            {{ visita.fecha_visita|format_fecha }} -
                            {% if visita.tipo == 'inicial' %}Primera visita{% else %}Seguimiento{% endif %}
                        </div>
                        <div class="visita-observaciones">{{ visita.observaciones or 'Sin observaciones' }}</div>
                        {% if visita.oportunidades %}
                        <div class="visita-oportunidad">Vinculada a: {{ visita.oportunidades.tipo }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="estado-vacio">No hay visitas registradas</div>
                {% endif %}

                <div class="add-item-button">
                    <a href="/crear_visita_seguimiento/{{ lead.id }}" class="btn btn--primary btn--rounded">+ Registrar Nueva Visita</a>
                </div>
            </div>

            <!-- OPORTUNIDADES COMERCIALES -->
            <div class="seccion">
                <h2>Oportunidades Comerciales</h2>

                {% if oportunidades %}
                    {% for op in oportunidades %}
                    <div class="list-item">
                        <div class="list-item__info">
                            <div class="list-item__title d-flex align-center gap-sm">
                                {{ op.tipo }}
                                <span class="badge badge--info">{{ op.estado|upper }}</span>
                            </div>
                            <div class="list-item__details">{{ op.descripcion or 'Sin descripción' }}</div>
                        </div>
                        <div class="list-item__actions">
                            <a href="/ver_oportunidad/{{ op.id }}" class="btn btn--primary btn--sm btn--rounded">Ver detalle</a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="estado-vacio">No hay oportunidades registradas para esta comunidad</div>
                {% endif %}

                <div class="add-item-button">
                    <a href="{{ url_for('oportunidades.crear_oportunidad', cliente_id=lead.id) }}" class="btn btn--primary btn--rounded">+ Crear Oportunidad</a>
                </div>
            </div>

            <!-- TAREAS DE GESTIÓN COMERCIAL -->
            <div class="seccion">
                <h2>Tareas de Gestión Comercial</h2>

                {% if tareas_comerciales %}
                    {% for tarea in tareas_comerciales %}
                    <div class="list-item">
                        <div class="list-item__info">
                            <div class="list-item__title d-flex align-center gap-sm">
                                {{ tarea.motivo_creacion|replace('_', ' ')|title }}
                                <span class="badge {% if tarea.estado == 'abierta' %}badge--success{% else %}badge--secondary{% endif %}">
                                    {{ tarea.estado|upper }}
                                </span>
                            </div>
                            <div class="list-item__details">
                                <strong>Creada:</strong> {{ tarea.fecha_creacion[:10] if tarea.fecha_creacion else 'N/A' }}

                                {% if tarea.estado == 'cerrada' %}
                                    {% if tarea.tipo_cierre %}
                                        <br><strong>Tipo de cierre:</strong> {{ tarea.tipo_cierre|replace('_', ' ')|title }}
                                    {% endif %}
                                    {% if tarea.motivo_cierre %}
                                        <br><strong>Motivo:</strong> {{ tarea.motivo_cierre }}
                                    {% endif %}
                                    {% if tarea.fecha_cierre %}
                                        <br><strong>Cerrada:</strong> {{ tarea.fecha_cierre[:10] }}
                                    {% endif %}
                                {% endif %}

                                {% if tarea.aplazada_hasta %}
                                    <br><strong>Aplazada hasta:</strong> {{ tarea.aplazada_hasta }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="estado-vacio">No hay tareas de gestión comercial registradas</div>
                {% endif %}
            </div>

            <!-- BOTONES DE ACCIÓN -->
            <div class="botones-accion">
                <a href="{{ url_for('leads.editar', lead_id=lead.id) }}" class="btn btn--primary btn--rounded">Editar Comunidad</a>
                <a href="{{ url_for('leads.dashboard') }}" class="btn btn--secondary btn--rounded">Volver al Dashboard</a>
            </div>

        </div>
    </main>

    <script>
        window.userPermissions = {{ permisos_usuario_json | safe }};
        window.perfilUsuario = '{{ perfil_usuario }}';
    </script>
    <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
</body>
</html>

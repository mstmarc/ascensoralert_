<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Defecto - AscensorAlert</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=6">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        header .header-container { display: flex; justify-content: center; align-items: center; }
        header .logo-container { display: flex; justify-content: center; align-items: center; }

        body { font-family: 'Montserrat', sans-serif; background: #ffffff; }
        main { max-width: 1000px !important; margin: 0 auto !important; padding: 40px !important; }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            color: #003366;
            font-size: 22px;
            font-weight: 700;
            margin: 0;
        }

        .badge-urgencia {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-vencido {
            background: #fee;
            color: #dc3545;
        }

        .badge-urgente {
            background: #fff8e1;
            color: #f57c00;
        }

        .badge-proximo {
            background: #e3f2fd;
            color: #1565c0;
        }

        .badge-normal {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-completado {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .info-card {
            background: #f8f9fa;
            border-left: 4px solid #003366;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
        }

        .info-section {
            background: white;
            border: 1px solid #e6e6e6;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .info-section h3 {
            color: #003366;
            font-size: 18px;
            font-weight: 700;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e6e6e6;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .info-item {
            margin-bottom: 15px;
        }

        .info-label {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 15px;
            color: #1a1a1a;
            font-weight: 500;
        }

        .info-value.large {
            font-size: 16px;
            line-height: 1.5;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-dl {
            background: #e3f2fd;
            color: #1565c0;
        }

        .badge-dg {
            background: #fff8e1;
            color: #f57c00;
        }

        .badge-dmg {
            background: #fee;
            color: #dc3545;
        }

        .badge-material {
            background: #f3e5f5;
            color: #7b1fa2;
            margin-left: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .button {
            background: #003c80;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .button:hover {
            background: #002f66;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .materiales-list {
            list-style: none;
            padding: 0;
        }

        .materiales-list li {
            padding: 10px;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid #7b1fa2;
        }

        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            color: #856404;
        }

        /* Dropdowns interactivos de gesti√≥n */
        .estado-display {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .estado-actual {
            background: #e8f4fd;
            border: 2px solid #bbdefb;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            color: #003366;
            min-height: 45px;
            display: flex;
            align-items: center;
        }

        .cambiar-gestion {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            background: white;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.2s;
            color: #003366;
        }

        .cambiar-gestion:focus {
            outline: none;
            border-color: #003366;
            box-shadow: 0 0 0 3px rgba(0,51,102,0.1);
        }

        .cambiar-gestion:hover {
            border-color: #003366;
        }

        .cambiar-gestion:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .cambiar-gestion option {
            padding: 10px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo-container">
                <a href="/home">
                    <img src="{{ url_for('static', filename='logo-fedes-ascensores.png') }}" alt="Logo" class="logo">
                </a>
            </div>
        </div>
    </header>

    <main>
        <div class="page-header">
            <div>
                <h2 class="page-title">üìã Detalle del Defecto</h2>
            </div>
            <div>
                {% if defecto.nivel_urgencia == 'VENCIDO' %}
                    <span class="badge-urgencia badge-vencido">‚ö†Ô∏è VENCIDO</span>
                {% elif defecto.nivel_urgencia == 'URGENTE' %}
                    <span class="badge-urgencia badge-urgente">üîî URGENTE</span>
                {% elif defecto.nivel_urgencia == 'PROXIMO' %}
                    <span class="badge-urgencia badge-proximo">üìÖ PR√ìXIMO</span>
                {% elif defecto.nivel_urgencia == 'NORMAL' %}
                    <span class="badge-urgencia badge-normal">‚úÖ NORMAL</span>
                {% elif defecto.nivel_urgencia == 'COMPLETADO' %}
                    <span class="badge-urgencia badge-completado">‚úîÔ∏è SUBSANADO</span>
                {% endif %}
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div style="background: {% if category == 'success' %}#d4edda{% else %}#f8d7da{% endif %};
                          color: {% if category == 'success' %}#155724{% else %}#721c24{% endif %};
                          padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <!-- Alerta de materiales especiales -->
        {% if defecto.es_cortina or defecto.es_pesacarga %}
        <div class="alert-warning">
            <strong>‚ö†Ô∏è Materiales Especiales Requeridos:</strong>
            {% if defecto.es_cortina %}üö™ Cortina Fotoel√©ctrica{% endif %}
            {% if defecto.es_cortina and defecto.es_pesacarga %} | {% endif %}
            {% if defecto.es_pesacarga %}‚öñÔ∏è Sistema Pesacarga{% endif %}
            <br>
            <small>Recuerda gestionar el pedido de estos materiales desde Gran Canaria o Tenerife</small>
        </div>
        {% endif %}

        <!-- Informaci√≥n del Defecto -->
        <div class="info-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e6e6e6;">
                <h3 style="margin: 0; padding: 0; border: none;">Informaci√≥n del Defecto</h3>
                <a href="{{ url_for('defectos.editar', defecto_id=defecto.id) }}" class="button" style="padding: 8px 16px; font-size: 13px;">‚úèÔ∏è Editar</a>
            </div>

            <div class="info-item">
                <div class="info-label">Descripci√≥n</div>
                <div class="info-value large">{{ defecto.descripcion }}</div>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Calificaci√≥n</div>
                    <div class="info-value">
                        <span class="badge badge-{{ defecto.calificacion|lower }}">{{ defecto.calificacion }}</span>
                        {% if defecto.calificacion == 'DL' %} - Defecto Leve
                        {% elif defecto.calificacion == 'DG' %} - Defecto Grave
                        {% elif defecto.calificacion == 'DMG' %} - Defecto Muy Grave
                        {% endif %}
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-label">Estado</div>
                    <div class="info-value">
                        {% if defecto.estado == 'PENDIENTE' %}
                            <span style="color: #f57c00; font-weight: 700;">PENDIENTE</span>
                        {% else %}
                            <span style="color: #2e7d32; font-weight: 700;">‚úîÔ∏è SUBSANADO</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Plazo</div>
                    <div class="info-value">{{ defecto.plazo_meses }} meses</div>
                </div>

                <div class="info-item">
                    <div class="info-label">Fecha L√≠mite</div>
                    <div class="info-value">
                        {{ defecto.fecha_limite|format_fecha }}
                        {% if defecto.estado == 'PENDIENTE' and defecto.dias_restantes is defined %}
                            {% if defecto.dias_restantes < 0 %}
                                <span style="color: #dc3545; font-weight: 700;">(‚ö†Ô∏è Vencido hace {{ defecto.dias_restantes|abs }} d√≠as)</span>
                            {% else %}
                                <span style="color: #1565c0; font-weight: 600;">(Quedan {{ defecto.dias_restantes }} d√≠as)</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if defecto.estado == 'SUBSANADO' and defecto.fecha_subsanacion %}
            <div class="info-item">
                <div class="info-label">Fecha de Subsanaci√≥n</div>
                <div class="info-value">{{ defecto.fecha_subsanacion|format_fecha }}</div>
            </div>
            {% endif %}

            {% if defecto.observaciones %}
            <div class="info-item">
                <div class="info-label">Observaciones</div>
                <div class="info-value large">{{ defecto.observaciones }}</div>
            </div>
            {% endif %}

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Requiere Materiales Especiales</div>
                    <div class="info-value">
                        {% if defecto.es_cortina %}<span class="badge badge-material">üö™ CORTINA</span>{% endif %}
                        {% if defecto.es_pesacarga %}<span class="badge badge-material">‚öñÔ∏è PESACARGA</span>{% endif %}
                        {% if not defecto.es_cortina and not defecto.es_pesacarga %}No{% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Gesti√≥n Operativa -->
        <div class="info-section">
            <h3>üë∑ Gesti√≥n Operativa</h3>

            <div class="info-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <!-- T√©cnico Asignado -->
                <div class="info-item" style="margin-bottom: 0;">
                    <div class="info-label" style="font-size: 11px; margin-bottom: 6px;">T√©cnico</div>
                    <div class="estado-display" style="gap: 6px;">
                        <div class="estado-actual" id="tecnicoActual" style="padding: 8px 12px; font-size: 13px; min-height: 36px;">
                            {% if defecto.tecnico_asignado == 'sergio' %}
                                üë∑ Sergio
                            {% elif defecto.tecnico_asignado == 'guimi' %}
                                üë∑ Guimi
                            {% elif defecto.tecnico_asignado == 'tenerife' %}
                                ‚úàÔ∏è Tenerife
                            {% elif defecto.tecnico_asignado == 'subcontrata' %}
                                üè¢ Subcon.
                            {% else %}
                                <span style="color: #999;">Sin asignar</span>
                            {% endif %}
                        </div>
                        <select class="cambiar-gestion" data-campo="tecnico" data-defecto-id="{{ defecto.id }}" style="padding: 7px 10px; font-size: 12px;">
                            <option value="">‚ö° Cambiar...</option>
                            <option value="sergio">üë∑ Sergio</option>
                            <option value="guimi">üë∑ Guimi</option>
                            <option value="tenerife">‚úàÔ∏è Tenerife</option>
                            <option value="subcontrata">üè¢ Subcon.</option>
                            <option value="">Sin asignar</option>
                        </select>
                    </div>
                </div>

                <!-- Gesti√≥n de Materiales -->
                <div class="info-item" style="margin-bottom: 0;">
                    <div class="info-label" style="font-size: 11px; margin-bottom: 6px;">Material</div>
                    <div class="estado-display" style="gap: 6px;">
                        <div class="estado-actual" id="materialActual" style="padding: 8px 12px; font-size: 13px; min-height: 36px;">
                            {% if defecto.gestion_material == 'comprar' %}
                                üõí Comprar GC
                            {% elif defecto.gestion_material == 'pedir_tenerife' %}
                                ‚úàÔ∏è Pedir TF
                            {% elif defecto.gestion_material == 'no_necesita' %}
                                ‚úÖ No necesita
                            {% else %}
                                <span style="color: #999;">Sin definir</span>
                            {% endif %}
                        </div>
                        <select class="cambiar-gestion" data-campo="material" data-defecto-id="{{ defecto.id }}" style="padding: 7px 10px; font-size: 12px;">
                            <option value="">‚ö° Cambiar...</option>
                            <option value="comprar">üõí Comprar GC</option>
                            <option value="pedir_tenerife">‚úàÔ∏è Pedir TF</option>
                            <option value="no_necesita">‚úÖ No necesita</option>
                            <option value="">Sin definir</option>
                        </select>
                    </div>
                </div>

                <!-- Estado de Stock -->
                <div class="info-item" style="margin-bottom: 0;">
                    <div class="info-label" style="font-size: 11px; margin-bottom: 6px;">Stock</div>
                    <div class="estado-display" style="gap: 6px;">
                        <div class="estado-actual" id="stockActual" style="padding: 8px 12px; font-size: 13px; min-height: 36px;">
                            {% if defecto.estado_stock == 'en_stock' %}
                                ‚úÖ En Stock
                            {% elif defecto.estado_stock == 'por_pedir' %}
                                üìã Por Pedir
                            {% elif defecto.estado_stock == 'pedido' %}
                                üì¶ Pedido
                            {% elif defecto.estado_stock == 'recibido' %}
                                üì• Recibido
                            {% elif defecto.estado_stock == 'instalado' %}
                                ‚úîÔ∏è Instalado
                            {% else %}
                                <span style="color: #999;">Sin definir</span>
                            {% endif %}
                        </div>
                        <select class="cambiar-gestion" data-campo="stock" data-defecto-id="{{ defecto.id }}" style="padding: 7px 10px; font-size: 12px;">
                            <option value="">‚ö° Cambiar...</option>
                            <option value="en_stock">‚úÖ En Stock</option>
                            <option value="por_pedir">üìã Por Pedir</option>
                            <option value="pedido">üì¶ Pedido</option>
                            <option value="recibido">üì• Recibido</option>
                            <option value="instalado">‚úîÔ∏è Instalado</option>
                            <option value="">Sin definir</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n de la Inspecci√≥n -->
        {% if defecto.inspeccion %}
        <div class="info-section">
            <h3>Inspecci√≥n Asociada</h3>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">RAE / M√°quina</div>
                    <div class="info-value">{{ defecto.inspeccion.maquina or '-' }}</div>
                </div>

                <div class="info-item">
                    <div class="info-label">Organismo OCA</div>
                    <div class="info-value">{{ defecto.inspeccion.oca_nombre or '-' }}</div>
                </div>
            </div>

            <div class="info-item">
                <div class="info-label">Ubicaci√≥n</div>
                <div class="info-value">
                    {{ defecto.inspeccion.direccion or '-' }}{% if defecto.inspeccion.poblacion %}, {{ defecto.inspeccion.poblacion }}{% endif %}
                </div>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Fecha de Inspecci√≥n</div>
                    <div class="info-value">{{ defecto.inspeccion.fecha_inspeccion|format_fecha if defecto.inspeccion.fecha_inspeccion else '-' }}</div>
                </div>

                {% if defecto.inspeccion.fecha_segunda_inspeccion %}
                <div class="info-item">
                    <div class="info-label">Fecha Segunda Inspecci√≥n</div>
                    <div class="info-value">{{ defecto.inspeccion.fecha_segunda_inspeccion|format_fecha }}</div>
                </div>
                {% endif %}
            </div>

            <div style="margin-top: 15px;">
                <a href="/inspecciones/ver/{{ defecto.inspeccion.id }}" class="button btn-secondary">Ver Inspecci√≥n Completa</a>
            </div>
        </div>
        {% endif %}

        <!-- Materiales Especiales Relacionados -->
        {% if materiales_relacionados %}
        <div class="info-section">
            <h3>üì¶ Materiales Especiales Gestionados</h3>
            <ul class="materiales-list">
                {% for material in materiales_relacionados %}
                <li>
                    <strong>{{ material.tipo }}</strong> -
                    Cantidad: {{ material.cantidad }} -
                    Estado: <strong>{{ material.estado }}</strong>
                    {% if material.fecha_pedido %} | Pedido: {{ material.fecha_pedido|format_fecha }}{% endif %}
                    {% if material.fecha_recepcion %} | Recibido: {{ material.fecha_recepcion|format_fecha }}{% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Botones de Acci√≥n -->
        <div class="action-buttons">
            <!-- Bot√≥n Toggle Subsanar/Revertir -->
            <form method="POST" action="{% if defecto.estado == 'PENDIENTE' %}{{ url_for('defectos.subsanar', defecto_id=defecto.id) }}{% else %}{{ url_for('defectos.revertir', defecto_id=defecto.id) }}{% endif %}" style="display: inline;">
                <button type="submit"
                        class="button {% if defecto.estado == 'PENDIENTE' %}btn-success{% else %}btn-warning{% endif %}"
                        onclick="return confirm('{% if defecto.estado == 'PENDIENTE' %}¬øMarcar este defecto como subsanado?{% else %}¬øRevertir este defecto a pendiente?{% endif %}')">
                    {% if defecto.estado == 'PENDIENTE' %}
                        ‚úÖ Marcar como Subsanado
                    {% else %}
                        ‚Ü©Ô∏è Marcar como Pendiente
                    {% endif %}
                </button>
            </form>

            <a href="{{ url_for('defectos.dashboard') }}" class="button btn-secondary">Volver al Dashboard</a>

            {% if session.get('perfil') == 'admin' %}
            <a href="{{ url_for('defectos.eliminar', defecto_id=defecto.id) }}"
               class="button btn-danger"
               onclick="return confirm('¬øEst√°s seguro de eliminar este defecto?')">
                üóëÔ∏è Eliminar
            </a>
            {% endif %}
        </div>

        <br><br>
    </main>

    <!-- Inyectar permisos del usuario para JavaScript -->
    <script>
        window.userPermissions = {{ permisos_usuario_json | safe }};
        window.perfilUsuario = '{{ perfil_usuario }}';
    </script>

    <script src="{{ url_for('static', filename='sidebar.js') }}"></script>

    <!-- Script para gesti√≥n operativa interactiva -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const selectores = document.querySelectorAll('.cambiar-gestion');

            // Mapeo de valores a textos para actualizar la UI
            const textosPorCampo = {
                tecnico: {
                    'sergio': 'üë∑ Sergio',
                    'guimi': 'üë∑ Guimi',
                    'tenerife': '‚úàÔ∏è Tenerife',
                    'subcontrata': 'üè¢ Subcon.',
                    '': '<span style="color: #999;">Sin asignar</span>'
                },
                material: {
                    'comprar': 'üõí Comprar GC',
                    'pedir_tenerife': '‚úàÔ∏è Pedir TF',
                    'no_necesita': '‚úÖ No necesita',
                    '': '<span style="color: #999;">Sin definir</span>'
                },
                stock: {
                    'en_stock': '‚úÖ En Stock',
                    'por_pedir': 'üìã Por Pedir',
                    'pedido': 'üì¶ Pedido',
                    'recibido': 'üì• Recibido',
                    'instalado': '‚úîÔ∏è Instalado',
                    '': '<span style="color: #999;">Sin definir</span>'
                }
            };

            selectores.forEach(selector => {
                selector.addEventListener('change', async function() {
                    const campo = this.dataset.campo;
                    const defectoId = this.dataset.defectoId;
                    const nuevoValor = this.value;

                    // Deshabilitar selector mientras se procesa
                    this.disabled = true;
                    this.style.opacity = '0.6';

                    try {
                        const response = await fetch(`{{ url_for('defectos.actualizar_gestion', defecto_id=0) }}`.replace('/0', `/${defectoId}`), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                campo: campo,
                                valor: nuevoValor
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            // Actualizar el display visual
                            const displayId = campo + 'Actual';
                            const displayElement = document.getElementById(displayId);
                            if (displayElement && textosPorCampo[campo]) {
                                displayElement.innerHTML = textosPorCampo[campo][nuevoValor];
                            }

                            // Resetear el selector
                            this.value = '';
                            this.disabled = false;
                            this.style.opacity = '1';

                            // Feedback visual
                            const estadoActual = displayElement;
                            if (estadoActual) {
                                estadoActual.style.background = '#d4edda';
                                estadoActual.style.borderColor = '#c3e6cb';
                                setTimeout(() => {
                                    estadoActual.style.background = '#e8f4fd';
                                    estadoActual.style.borderColor = '#bbdefb';
                                }, 1500);
                            }
                        } else {
                            alert('Error al actualizar: ' + (data.error || 'Error desconocido'));
                            this.value = '';
                            this.disabled = false;
                            this.style.opacity = '1';
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error al actualizar. Por favor, intenta de nuevo.');
                        this.value = '';
                        this.disabled = false;
                        this.style.opacity = '1';
                    }
                });
            });
        });
    </script>
</body>
</html>
